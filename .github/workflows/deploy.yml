name: Deploy

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: fullstack-app-base
  GCP_REGION: asia-northeast1
  BACKEND_IMAGE_NAME: backend

jobs:
  ci:
    name: "CI (Lint & Test)"
    uses: ./.github/workflows/ci.yml

  get-terraform-outputs:
    name: Get Infrastructure Info
    runs-on: ubuntu-latest
    needs: ci
    defaults:
      run:
        working-directory: infra/terraform
    outputs:
      cloud_run_url: ${{ steps.outputs.outputs.cloud_run_url }}
      cloud_run_service_name: ${{ steps.outputs.outputs.cloud_run_service_name }}
      cloud_run_location: ${{ steps.outputs.outputs.cloud_run_location }}
      docker_image_url_base: ${{ steps.outputs.outputs.docker_image_url_base }}
      db_migrate_job_name: ${{ steps.outputs.outputs.db_migrate_job_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Terraform Init (read-only)
        run: terraform init

      - name: Read Terraform Outputs
        id: outputs
        run: |
          echo "cloud_run_url=$(terraform output -raw cloud_run_url)" >> $GITHUB_OUTPUT
          echo "cloud_run_service_name=$(terraform output -raw cloud_run_service_name)" >> $GITHUB_OUTPUT
          echo "cloud_run_location=$(terraform output -raw cloud_run_location)" >> $GITHUB_OUTPUT
          echo "docker_image_url_base=$(terraform output -raw docker_image_url_base)" >> $GITHUB_OUTPUT
          echo "db_migrate_job_name=$(terraform output -raw db_migrate_job_name)" >> $GITHUB_OUTPUT

  deploy-backend:
    name: "Deploy Backend"
    runs-on: ubuntu-latest
    needs: get-terraform-outputs
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GCP
        uses: ./.github/actions/setup-gcp
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: "Build Docker image (Full-stack: Frontend + Backend)"
        run: |
          docker build \
            --build-arg VITE_API_BASE_URL=/api \
            -t ${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:latest \
            -f backend/Dockerfile \
            .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:latest

      - name: Update Migration Job Image
        run: |
          gcloud run jobs update ${{ needs.get-terraform-outputs.outputs.db_migrate_job_name }} \
            --image=${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            --region=${{ needs.get-terraform-outputs.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Run Database Migrations
        run: |
          echo "ðŸ”„ Running database migrations..."
          gcloud run jobs execute ${{ needs.get-terraform-outputs.outputs.db_migrate_job_name }} \
            --region=${{ needs.get-terraform-outputs.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --wait

          echo "âœ… Database migrations completed successfully"

      - name: Deploy to Cloud Run
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD_HASH: ${{ secrets.ADMIN_PASSWORD_HASH }}
          APP_VERSION: ${{ github.ref_name }}
        run: |
          # Use env vars to avoid shell expansion of special characters in bcrypt hash
          gcloud run deploy ${{ needs.get-terraform-outputs.outputs.cloud_run_service_name }} \
            --image=${{ needs.get-terraform-outputs.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            --platform=managed \
            --region=${{ needs.get-terraform-outputs.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --update-env-vars "ADMIN_EMAIL=${ADMIN_EMAIL},ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH},COOKIE_SECURE=true,APP_VERSION=${APP_VERSION}" \
            --quiet

      - name: Run Health Check
        run: |
          echo "Running health check with retry logic..."
          HEALTH_URL="${{ needs.get-terraform-outputs.outputs.cloud_run_url }}/api/health"
          INITIAL_WAIT=60
          MAX_RETRIES=10
          RETRY_INTERVAL=15

          echo "â³ Waiting ${INITIAL_WAIT}s for server to start..."
          sleep $INITIAL_WAIT

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking $HEALTH_URL"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" --max-time 10) || HTTP_STATUS="000"

            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… Health check passed (HTTP $HTTP_STATUS) after $i attempt(s)"
              exit 0
            else
              echo "âš ï¸  Health check returned HTTP $HTTP_STATUS"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "   Retrying in ${RETRY_INTERVAL}s..."
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Display Application URLs
        run: |
          echo "ðŸš€ Full-stack application deployed successfully!"
          echo "ðŸŒ Application URL: ${{ needs.get-terraform-outputs.outputs.cloud_run_url }}"
          echo "ðŸ“± Frontend: ${{ needs.get-terraform-outputs.outputs.cloud_run_url }}/"
          echo "âš™ï¸  Backend API: ${{ needs.get-terraform-outputs.outputs.cloud_run_url }}/api"
          echo "ðŸ¥ Health Check: ${{ needs.get-terraform-outputs.outputs.cloud_run_url }}/api/health"

  create-release:
    name: "Create GitHub Release"
    runs-on: ubuntu-latest
    needs: deploy-backend
    # Only run on tag pushes, not on manual workflow dispatch
    if: github.ref_type == 'tag'
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tag comparison

      - name: Make release notes script executable
        run: chmod +x .github/scripts/generate-release-notes.sh

      - name: Generate Release Notes
        id: release_notes
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          CURRENT_TAG="${{ github.ref_name }}"
          RELEASE_NOTES=$(.github/scripts/generate-release-notes.sh "$CURRENT_TAG")

          # Save release notes to file for GitHub Release
          echo "$RELEASE_NOTES" > release_notes.md

          # Also output for logging
          echo "Generated release notes:"
          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}  # Mark as prerelease if tag contains hyphen (e.g., v1.0.0-rc.1)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
