name: Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: fullstack-app-base
  GCP_REGION: asia-northeast1
  BACKEND_IMAGE_NAME: backend

jobs:
  ci:
    name: "CI (Lint & Test)"
    uses: ./.github/workflows/ci.yml

  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: ci
    defaults:
      run:
        working-directory: infra/terraform
    outputs:
      cloud_run_url: ${{ steps.outputs.outputs.cloud_run_url }}
      cloud_run_service_name: ${{ steps.outputs.outputs.cloud_run_service_name }}
      cloud_run_location: ${{ steps.outputs.outputs.cloud_run_location }}
      docker_image_url_base: ${{ steps.outputs.outputs.docker_image_url_base }}
      db_migrate_job_name: ${{ steps.outputs.outputs.db_migrate_job_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.9.0
          terraform_wrapper: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan -no-color -input=false \
            -var="cloud_sql_password=${{ secrets.DATABASE_PASSWORD }}" \
            -var="flask_secret_key=${{ secrets.FLASK_SECRET_KEY }}" \
            -out=tfplan

      - name: Show Terraform Plan
        run: terraform show -no-color tfplan

      - name: Terraform Apply
        run: |
          terraform apply -auto-approve -input=false tfplan

      - name: Save Terraform Outputs
        id: outputs
        run: |
          echo "cloud_run_url=$(terraform output -raw cloud_run_url)" >> $GITHUB_OUTPUT
          echo "cloud_run_service_name=$(terraform output -raw cloud_run_service_name)" >> $GITHUB_OUTPUT
          echo "cloud_run_location=$(terraform output -raw cloud_run_location)" >> $GITHUB_OUTPUT
          echo "docker_image_url_base=$(terraform output -raw docker_image_url_base)" >> $GITHUB_OUTPUT
          echo "db_migrate_job_name=$(terraform output -raw db_migrate_job_name)" >> $GITHUB_OUTPUT

  deploy-backend:
    name: "Deploy Backend"
    runs-on: ubuntu-latest
    needs: terraform
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: "Build Docker image (Full-stack: Frontend + Backend)"
        run: |
          docker build \
            --build-arg VITE_API_BASE_URL=/api \
            -t ${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:latest \
            -f backend/Dockerfile \
            .

      - name: Push Docker image to Artifact Registry
        run: |
          docker push ${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:latest

      - name: Update Migration Job Image
        run: |
          gcloud run jobs update ${{ needs.terraform.outputs.db_migrate_job_name }} \
            --image=${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            --region=${{ needs.terraform.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: Run Database Migrations
        run: |
          echo "üîÑ Running database migrations..."
          gcloud run jobs execute ${{ needs.terraform.outputs.db_migrate_job_name }} \
            --region=${{ needs.terraform.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --wait

          echo "‚úÖ Database migrations completed successfully"

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ needs.terraform.outputs.cloud_run_service_name }} \
            --image=${{ needs.terraform.outputs.docker_image_url_base }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }} \
            --platform=managed \
            --region=${{ needs.terraform.outputs.cloud_run_location }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --quiet

      - name: Run Health Check
        run: |
          echo "Running health check with retry logic..."
          HEALTH_URL="${{ needs.terraform.outputs.cloud_run_url }}/api/health"
          MAX_RETRIES=12
          RETRY_INTERVAL=5

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Checking $HEALTH_URL"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" --max-time 10)

            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "‚úÖ Health check passed (HTTP $HTTP_STATUS) after $i attempt(s)"
              exit 0
            else
              echo "‚ö†Ô∏è  Health check returned HTTP $HTTP_STATUS"
              if [ $i -lt $MAX_RETRIES ]; then
                echo "   Retrying in ${RETRY_INTERVAL}s..."
                sleep $RETRY_INTERVAL
              fi
            fi
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Display Application URLs
        run: |
          echo "üöÄ Full-stack application deployed successfully!"
          echo "üåê Application URL: ${{ needs.terraform.outputs.cloud_run_url }}"
          echo "üì± Frontend: ${{ needs.terraform.outputs.cloud_run_url }}/"
          echo "‚öôÔ∏è  Backend API: ${{ needs.terraform.outputs.cloud_run_url }}/api"
          echo "üè• Health Check: ${{ needs.terraform.outputs.cloud_run_url }}/api/health"
